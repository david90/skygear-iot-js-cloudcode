<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IoT panel</title>
    <script src="https://code.skygear.io/js/polyfill/latest/polyfill.min.js"></script>
    <script src="https://code.skygear.io/js/skygear/latest/skygear.min.js"></script>

    <script
  src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
  crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-blue.min.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  </head>
  <body>


  <style>
  .demo-layout-transparent {
    background: url('../assets/demos/transparent.jpg') center / cover;
  }
  .demo-layout-transparent .mdl-layout__header,
  .demo-layout-transparent .mdl-layout__drawer-button {
    /* This background is dark, so we set text to white. Use 87% black instead if
       your background is light. */
    color: white;
  }
  </style>

  <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--2-col"></div>
    <div class="mdl-cell mdl-cell--6-col">Current ID: <span class="currentUserId">Loading..</span></div>
  </div>

  <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--2-col"></div>
    <div class="mdl-cell mdl-cell--8-col">
        <h5>Click to manually ping all devices.</h5>
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent ping-button">
      Ping
    </button>
    </div>
  </div>

  <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--2-col"></div>
    <div class="mdl-cell mdl-cell--4-col">
    <h5>Device Status</h5>
      <div id="p2" class="mdl-progress mdl-js-progress mdl-progress__indeterminate"></div>
      <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp" style="width:100%">
        <thead>
          <tr>
            <th class="mdl-data-table__cell--non-numeric">Device</th>
            <th>Platform</th>
            <th>Last Report</th>
          </tr>
        </thead>
        <tbody class="status-table">
        <!-- Device Status here -->
        </tbody>
      </table>
    </div>
  </div>
  <div id="demo-toast-example" class="mdl-js-snackbar mdl-snackbar">
    <div class="mdl-snackbar__text"></div>
    <button class="mdl-snackbar__action" type="button"></button>
  </div>

  <script>

  /* Init Skygear */ 
  skygear.config({
    'endPoint': 'https://iotsample.skygeario.com/',
    'apiKey': 'fe8bc005f8cb4f8b92b187dee6e96f6f',
  }).then(() => {
    console.log('skygear container is now ready for making API calls.');

    if (skygear.currentUser) {
        $('.currentUserId').text(skygear.currentUser.id);
        subscribeAllHandlers();
    } else {
      skygear.signupAnonymously().then((user) => {
        console.log(user); // user object with undefined email and username
        $('.currentUserId').text(skygear.currentUser.id);
        subscribeAllHandlers();
      }, (error) => {
        console.error(error);
      });
    }

  }, (error) => {
    console.error(error);
  });

  /** Pubsub **/

  // Subscribe to ping events
  function subscribePing() {
      skygear.on('ping', (data) => {
      console.log(data);

      $("#p2").hide();
      replyToPing();
    });
  }

  // Subscribe to reply events
  function subscribeReply() {
      // whenever a device replies
      skygear.on('reply', (data) => {
      console.log('A device replied!');
      statusTable.updateRecord(data)
    });
  }

  // We also subscribe to Report saved event
  function subscribeReportSaved() {
      skygear.on('report-saved', (data) => {
      console.log(data);
      var reportId = data._id;
      var content = data.content;
      var message =  ''+ content + ' (' + reportId + ')';
      showReportToast(message);
    });
  }

  // A wrapper for all subscriptions
  function subscribeAllHandlers() {
    subscribePing();
    subscribeReply();
    subscribeReportSaved();
  }

  // We initiated a ping from the web pannel
  function pingDevices() {
      skygear.pubsub.publish('ping',{msg:"from web pannel"});
  }

  // The web pannel will reply to the ping also
  function replyToPing() {
      skygear.pubsub.publish('reply',{
        device: skygear.currentUser.id,
        platform: 'web pannel',
        lastReply: Date()
      });
  }

  /* UI */

  // The status table view controller
  var statusTable = null;
  var statusTableEl = $('.status-table');
  var statusRecordTemplate = '<tr class="status-record-row"> \
          <td class="mdl-data-table__cell--non-numeric device"></td> \
          <td class="platform"></td> \
          <td class="report-time"></td> \
          </tr>';

  function StatusTable (el) {
    this.el = el;
    this.updateRecord = function(replyObject) {
      console.log(replyObject);
      var id = replyObject.device;
      var viewArray = findRecordView(id);
      var view = null;
      if(viewArray.length == 0) {
         view = createRecordView(id);
         el.append(view);
      } else {
        view = viewArray[0];
      }

      $(view).find('.platform').text(replyObject.platform);
      $(view).find('.report-time').text(replyObject.lastReply);

    }

    var findRecordView = function(deviceId) {
      var view = el.find('.status-record-row[data-deviceID="'+deviceId+'"]');
      return view;
    }

    var createRecordView = function(deviceId) {
      var view = $(statusRecordTemplate);
      var deviceView = view.find('.device');
      view.attr('data-deviceId', deviceId);
      deviceView.text(deviceId);
      return view;
    }

  }

  $().ready(function(){
    statusTable = new StatusTable(statusTableEl);
  })

  function showReportToast(message) {
    var snackbarContainer = document.querySelector('#demo-toast-example');
    var showToastButton = document.querySelector('#demo-show-toast');
    snackbarContainer.MaterialSnackbar.showSnackbar({message: message});
  }

  // Button events
  $('.ping-button').on('click',function(e){
    pingDevices();
  })

  </script>

  </body>
</html>