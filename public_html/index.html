<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IoT panel</title>
    <script src="https://code.skygear.io/js/polyfill/latest/polyfill.min.js"></script>
    <script src="https://code.skygear.io/js/skygear/latest/skygear.min.js"></script>

    <script
  src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
  crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-blue.min.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  </head>
  <body>


<style>
.demo-layout-transparent {
  background: url('../assets/demos/transparent.jpg') center / cover;
}
.demo-layout-transparent .mdl-layout__header,
.demo-layout-transparent .mdl-layout__drawer-button {
  /* This background is dark, so we set text to white. Use 87% black instead if
     your background is light. */
  color: white;
}
</style>

<div class="mdl-grid">
  <div class="mdl-cell mdl-cell--4-col"></div>
  <div class="mdl-cell mdl-cell--4-col">
      <h5>Click to manually ping all devices.</h5>
      <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent ping-button">
    Ping
  </button>
  </div>
  <div class="mdl-cell mdl-cell--4-col"></div>
</div>


<div class="mdl-grid">
  <div class="mdl-cell mdl-cell--4-col"></div>
  <div class="mdl-cell mdl-cell--4-col">
  <h5>Device Status</h5>
    <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
      <thead>
        <tr>
          <th class="mdl-data-table__cell--non-numeric">Device</th>
          <th>Platform</th>
          <th>Last Report</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="mdl-data-table__cell--non-numeric">c2dn89h2hc0c9sh0sbd20en</td>
          <td>Android</td>
          <td>Date</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<div id="demo-toast-example" class="mdl-js-snackbar mdl-snackbar">
  <div class="mdl-snackbar__text"></div>
  <button class="mdl-snackbar__action" type="button"></button>
</div>

  <script>

  /* Init Skygear */ 
  skygear.config({
    'endPoint': 'https://iotsample.skygeario.com/',
    'apiKey': 'fe8bc005f8cb4f8b92b187dee6e96f6f',
  }).then(() => {
    console.log('skygear container is now ready for making API calls.');

    if (skygear.currentUser) {
        subscribeAllHandlers();
    } else {
      skygear.signupAnonymously().then((user) => {
        console.log(user); // user object with undefined email and username
        subscribeAllHandlers();
      }, (error) => {
        console.error(error);
      });
    }

  }, (error) => {
    console.error(error);
  });

  /** Pubsub **/

  // Subscribe to ping events
  function subscribePing() {
      skygear.on('ping', (data) => {
      console.log(data);
      replyToPing();
    });
  }

  // Subscribe to reply events
  function subscribeReply() {
      // whenever a device replies
      skygear.on('reply', (data) => {
      console.log('A device replied!');
      console.log(data);
    });
  }

  // We also subscribe to Report saved event
  function subscribeReportSaved() {
      skygear.on('report-saved', (data) => {
      console.log(data);
      var message = 'Report saved from device'
      showReportToast(message);
    });
  }

  // A wrapper for all subscriptions
  function subscribeAllHandlers() {
    subscribePing();
    subscribeReply();
    subscribeReportSaved();
  }

  // We initiated a ping from the web pannel
  function pingDevices() {
      skygear.pubsub.publish('ping',{msg:"from web pannel"});
  }

  // The web pannel will reply to the ping also
  function replyToPing() {
      skygear.pubsub.publish('reply',{
        device: skygear.currentUser.id,
        platform: 'web pannel',
        lastReply: Date()
      });
  }


  /* UI */

  $('.ping-button').on('click',function(e){
    pingDevices();
  })

  function showReportToast(message) {
    var snackbarContainer = document.querySelector('#demo-toast-example');
    var showToastButton = document.querySelector('#demo-show-toast');
    snackbarContainer.MaterialSnackbar.showSnackbar({message: message});
  }

  </script>

  </body>
</html>